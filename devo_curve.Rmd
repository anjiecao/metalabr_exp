---
title: "devo curve"
author: "anjie"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(tidyverse)
library(here)
library(ggthemes)

library(metafor)

d <- read_csv(here("data/clean_data.csv"))

```

```{r}
filter(d, 
       mean_age_months < 36) %>%
  ggplot(aes(x = mean_age_months, y = d_calc, 
             weight = 1/d_var_calc)) +
  geom_point(aes(size = 1/d_var_calc),
             alpha = .3) + 
  geom_smooth(method="lm", formula = y ~ x, 
              aes(col = "Linear"), 
              se = FALSE) + 
  geom_smooth(method="lm", formula = y ~ log(x), 
              aes(col = "Log"),
              se = FALSE) + 
  geom_smooth(method="lm", formula = y ~ I(x^2),
              aes(col = "Quadratic"),
              se = FALSE) +
  facet_wrap(~ ds_clean) + 
  geom_hline(yintercept = 0, lty = 2, col = "black") + 
  xlab("Mean age (months)") +
  ylab("Effect size (d)") +
  scale_colour_solarized(name="Models", breaks = c("Linear", "Log",
                                                "Quadratic", "Linear and Log"),
                                     labels=c("Linear" = "Linear",
                                              "Log" = "Log",
                                              "Quadratic" = "Quadratic",
                                              "Linear and Log" = "Linear and Log")) +
  ggthemes::theme_few()
```

```{r}


```



```{r}
get_compare_IC_df <- function(all_ds, ds_name, moderators){
  
  if (is.null(moderators)){
    linear_model_formula <-"d_calc ~ mean_age_months"
  log_model_formula <- "d_calc ~ log(mean_age_months)"
  qua_model_formula <- "d_calc ~ I(mean_age_months^2)"
  
  
  }else{
    
  
  linear_model_formula <- paste0("d_calc ~ mean_age_months + ", paste(moderators, collapse = " + "))
  log_model_formula <- paste0("d_calc ~ log(mean_age_months) + ", paste(moderators, collapse = " + "))
  qua_model_formula <- paste0("d_calc ~ I(mean_age_months^2) + ", paste(moderators, collapse = " + "))
    
  }
  

  
  
  res = lapply(c(linear_model_formula, 
           log_model_formula, 
           qua_model_formula), 
         function(m){
           print(m)
           # check if has same_infant
           
           if (ds_name %in% (d %>% filter(is.na(same_infant)) %>% distinct(ds_clean) %>% pull())){
             
           raw_df <- (summary(rma.mv(as.formula(m), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/unique_row, 
                  data = all_ds %>% filter(ds_clean == ds_name)))$fit.stats) %>% 
             mutate(model_spec = m) %>% 
             rownames_to_column("ic") 
             
           }else if(ds_name %in% (d %>% filter(is.na(unique_row)) %>% distinct(ds_clean) %>% pull())){
             
           raw_df <- (summary(rma.mv(as.formula(m), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant, 
                  data = all_ds %>% filter(ds_clean == ds_name)))$fit.stats) %>% 
             mutate(model_spec = m) %>% 
             rownames_to_column("ic") 
             
           }else{
           
           raw_df <- (summary(rma.mv(as.formula(m), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant/unique_row, 
                  data = all_ds %>% filter(ds_clean == ds_name)))$fit.stats) %>% 
             mutate(model_spec = m) %>% 
             rownames_to_column("ic") 
             
           }
           
           
         }) %>% 
    bind_rows() %>% 
    mutate(dataset = ds_name) %>% 
    mutate(model_spec_clean = case_when(
      grepl("log", model_spec) ~ "Log", 
      grepl("2", model_spec) ~ "Quadratic", 
      TRUE ~ "Linear"
    ))
  
  return (res)
}

```


```{r}
 (d %>% arrange(ds_clean) %>% distinct(ds_clean)) %>% pull()
```


```{r}

get_moderators <- function(ds_name){
  moderator_df <- d %>% 
  filter(ds_clean == ds_name) %>% 
  summarise_all(n_distinct) %>% 
  pivot_longer(cols = everything(), 
               names_to = "column_name", 
               values_to = "n_distinct_value") %>% 
  filter(n_distinct_value != 1) %>% 
  filter(!column_name %in% c("unique_row", 
                             "study_ID", 
                             "long_cite", 
                             "short_cite", 
                             "peer_reviewed", 
                             "expt_num", 
                             "expt_condition", 
                             "same_infant", 
                             "n_1", 
                             "mean_age_1", 
                             "x_1", 
                             "x_2", 
                             "SD_1", 
                             "SD_2", 
                             "t", 
                             "F", 
                             "d", 
                             "corr", 
                             "age_range_1", 
                             "n_excluded_1", 
                             "n_excluded_2",
                             "gender_2", 
                             "corr_imputed", 
                             "d_calc", 
                             "d_var_calc", 
                             "g_calc", 
                             "g_var_calc", 
                             "r_calc", 
                             "r_var_calc", 
                             "z_calc", 
                             "z_var_calc", 
                             "log_odds_calc", 
                             "log_odds_var_calc", 
                             "es_method", 
                             "mean_age", 
                             "n", 
                             "same_infant_calc", 
                             "mean_age_months", 
                             "year", 
                             "group_name_2",
                             "group_name_1",
                             "infant_type",
                             "r", 
                             "gender_1",
                             "gender_2",
                              "coder", 
                             "publication_type",
                             "dataset", 
                             "short_name", 
                             "d_var", 
                             "age_range_2", 
                             "original_ma", 
                             "lab",
                             "data_from_figure",
                             "effect_significance_reported",
                             "non_criterion", 
                             "criterion",
                             "Coder 1 Comments", 
                             "coder",
                             "n_2", 
                             "mean_age_2", 
                             "age_range_2", 
                             "n_excluded_2", 
                             "main_question_IDS_preference",
                            "fussers",
                            "participant_design", 
                            "expt_condition2",
                            "word_round", 
                            "word_spiky",
                            "participant_design",
                            "x_dif", 
                            "F1_1", 
                            "F1_2", 
                            "F2_1",
                            "F2_2",
                            "Linguistic", 
                            "preceding", 
                            "native_lang", 
                            "test_register", 
                            "percentV", 
                            "deltaC", 
                            # SB parsing issue 
                            "n_train_test_pair", 
                            "n_test_trial_per_pair", 
                            "n_repetitions_sentence", 
                            "n_repetitions_video",
                            
                            # too detailed for VD
                            "contrast_sampa", 
                            "contrast_pseudoIPA", 
                            "sampa_comments", 
                            "counterbalanced", 
                            "backness", 
                            "height", 
                            "nasality", 
                            "roundness", 
                            "tenseness", 
                            "length", 
                            "duration_word_1", 
                            "duration_word_2", 
                            "duration_vowel_1", 
                            "duration_vowel_2", 
                            "peripherality"
                            
                             )) %>% 
  mutate(ds_clean =  ds_name) %>% 
  select(-n_distinct_value) %>% 
  nest(moderator_name = column_name)
  
}



ds_with_moderators <- lapply((d %>% arrange(ds_clean) %>% distinct(ds_clean)) %>% pull(), 
        function(x){
          get_moderators(x)
        }) %>% 
   bind_rows() 

```


# kitchen sink models

```{r}
kitchen_sink_models_df <- lapply(ds_with_moderators$ds_clean, 
       function(name){
         print(name)
         get_compare_IC_df(d, name, (ds_with_moderators %>% filter(ds_clean == name))$moderator_name[[1]] %>% pull())
       }) %>% 
  bind_rows()
```

```{r}
kitchen_sink_models_df %>% 
  filter(ic == "AICc") %>% 
   ggplot(aes(x = ic, y = REML, color = model_spec_clean, group = model_spec_clean)) + 
  geom_point(position = position_dodge(width = .2)) + 
  theme_classic() + 
  facet_wrap(~dataset, scales = "free")
```

wants to make sure the kitchen sink model and the age model has the same form 

for some datasets, when adding vs not adding method moderators, it yielded different best shapes

# age models

```{r}
age_models_df <- lapply(ds_with_moderators$ds_clean, 
       function(name){
         print(name)
         get_compare_IC_df(d, name, NULL)
       }) %>% 
  bind_rows()
```


```{r}
min_ks_df <- kitchen_sink_models_df %>% 
  filter(ic == "AICc") %>% 
  group_by(dataset) %>% 
  filter(REML == min(REML)) %>% 
  rename(REML_ks = REML, 
         model_spec_ks = model_spec, 
         model_spec_clean_ks = model_spec_clean)

min_age_df <- age_models_df %>% 
  filter(ic == "AICc") %>% 
  group_by(dataset) %>% 
  filter(REML == min(REML)) %>% 
  rename(REML_age = REML, 
         model_spec_age = model_spec,
         model_spec_clean_age = model_spec_clean)

min_ks_df %>% 
  left_join(min_age_df, by = c("dataset", "ic")) %>% 
  select(dataset, REML_ks, REML_age, model_spec_clean_ks, model_spec_clean_age)
  filter(! model_spec_clean_age == model_spec_clean_ks)
```

but let's ignore all of those and select the min of all

```{r}
min_AIC_df <- age_models_df %>% mutate(model_type = "base_age") %>% 
  bind_rows(kitchen_sink_models_df %>% mutate(model_type = "kitchen_sink")) %>% 
  filter(ic == "AICc") %>% 
  group_by(dataset) %>% 
  filter(REML == min(REML)) 

min_AIC_df <- min_AIC_df %>% 
  mutate(
    min_AIC_df = case_when(
      model_spec == "d_calc ~ I(mean_age_months^2)" | model_spec == "d_calc ~ log(mean_age_months)" | model_spec == "d_calc ~ mean_age_months" ~ "base_age_model", 
      TRUE ~ "method_moderators_model"
    )
  )

min_AIC_df
```


# for getting age model

```{r}
get_compare_IC_df <- function(ds_name, min_age_df, all_ds){
  
  current_df = all_ds %>% filter(ds_clean == ds_name)
  formula = (min_age_df %>% filter(dataset == ds_name))$model_spec_age
  model_type = (min_age_df %>% filter(dataset == ds_name))$model_spec_clean_age
  
  
  if (ds_name %in% (all_ds %>% filter(is.na(same_infant)) %>% distinct(ds_clean) %>% pull())){
             
           model <- rma.mv(as.formula(formula), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/unique_row, 
                  data = current_df) 
             
    }else if(ds_name %in% (all_ds %>% filter(is.na(unique_row)) %>% distinct(ds_clean) %>% pull())){
             
           model <- rma.mv(as.formula(formula), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant, 
                  data = current_df) 
             
    }else{
           
           model <- rma.mv(as.formula(formula), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant/unique_row, 
                  data = current_df)
             
    }
  
  if (model_type == "Log"){
    age = log(seq(1, 36, .5))
  }else if(model_type == "Quadratic"){
    age = (seq(1, 36, .5)) ** 2
  }else{
    age = seq(1, 10, .5)
  }
   
     
  prediction =  predict(model, newmods = age, addx =TRUE) %>% 
    as.data.frame() %>% 
    mutate(ds_name = ds_name)
  
  
  
  
  return (prediction)
}


```


```{r}
saveRDS(min_age_df, here("min_age_df.RDS"))
min_age_df <- readRDS(here("min_age_df.RDS"))


all_pred <- lapply(seq(1, nrow(min_age_df)), 
       function(x){
         get_compare_IC_df(min_age_df$dataset[[x]], min_age_df, d)
       }) %>% 
  bind_rows()


all_pred %>% 
  select(pred, ds_name) %>% 
  group_by(ds_name) %>% 
  mutate(mean_age_months = (row_number() + 1) / 2) %>% 
  mutate(
    ds_type = case_when(
      ds_name %in% c("Familiar word recognition", 
                     "Infant directed speech preference", 
                     "Language discrimination and preference", 
                     "Mispronunciation sensitivity", 
                     "Natural speech preference", "Sound symbolism",
                     "Statistical sound category learning (habituation)",
                     "Statistical word segmentation",
                     "Vowel discrimination (native)",
                     "Vowel discrimination (non-native)" ,"Word Segmentation (combined)" ) ~ "Language - perceptual", 
      ds_name %in% c("Cross-situational word learning", 
                      "Label advantage in concept learning",
                     "Mutual exclusivity",
                     "Online word recognition",
                     "Switch task",
                     "Syntactic bootstrapping" 
                     ) ~ "Language - conceptual", 
      ds_name %in% c("Gaze following (combined)", "Prosocial agents") ~ "Social",
      ds_name %in% c("Abstract rule learning",  "Categorization bias", 
                     "Simple arithmetic competences", "Symbolic play") ~ "Cognitive"
     )
  ) %>% 
  select(ds_name, ds_type)
  
  
  
  ggplot(aes(x = mean_age_months, y = pred, color = ds_name)) + 
  geom_point()
```



# test case for getting prediction with moderators， kinda  make sense

```{r}
test_d <- d %>% filter(ds_clean == "Language discrimination and preference")
test_f <- "d_calc ~ I(mean_age_months^2) + exposure_phase "


m <- rma.mv(as.formula(test_f), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant/unique_row, 
                  data = test_d)


coded_var <-- summary(m)$X.f %>% as.data.frame()


predict(
  m, addx = TRUE, 
  newmods = as.matrix(data.frame(
    mean_age_months = (seq(1, 10, 1)) ** 2, 
    exposure_phasehabituation = rep(-1, 10), 
    exposure_phasetest_only = rep(0, 10)
  ))
) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = (X.I.mean_age_months.2.) **.5, 
             y = pred)) + 
  geom_point()

test_d$mean_age_months
```



 
# get min prediction 


summary(model)$X.f for coding 

```{r}
get_compare_IC_df <- function(ds_name, all_ds, formula){
  
  current_df = all_ds %>% filter(ds_clean == ds_name)
  
  
  if (ds_name %in% (all_ds %>% filter(is.na(same_infant)) %>% distinct(ds_clean) %>% pull())){
             
           model <- rma.mv(as.formula(formula), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/unique_row, 
                  data = current_df) 
             
    }else if(ds_name %in% (all_ds %>% filter(is.na(unique_row)) %>% distinct(ds_clean) %>% pull())){
             
           model <- rma.mv(as.formula(formula), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant, 
                  data = current_df) 
             
    }else{
           
           model <- rma.mv(as.formula(formula), 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant/unique_row, 
                  data = current_df)
             
    }
  
   
        
  prediction =  predict(model, addx =TRUE) %>% as.data.frame()
  
  # drop the rows that's dropped when fitting models 
  current_df$keep = model$not.na
  current_df = current_df[current_df$keep, ]
  
  current_df$prediction = prediction$pred 
  
  
  
  return (current_df)
}
```


```{r}
pred_df <- lapply(seq(1, nrow(min_AIC_df)), 
       function(x){
         get_compare_IC_df(min_AIC_df$dataset[[x]], 
                  d, 
                  min_AIC_df$model_spec[[x]]) 
       }) %>% 
  bind_rows()


pred_df_with_curve_shape <- pred_df %>% 
  left_join(min_AIC_df %>% rename(ds_clean = dataset) %>% select(ds_clean, model_spec_clean, model_moderators_type), 
            by = c("ds_clean"))


pred_df_with_curve_shape %>% 
  ggplot(aes(x = mean_age_months, y = prediction, color = model_spec_clean)) + 
  geom_point(alpha = .5) +
  geom_smooth() +
  facet_wrap(~ds_clean, scales = "free")


```

```{r}
pred_df %>% 
  filter(mean_age_months < 36) %>% 
  ggplot(aes(x = mean_age_months, y = prediction, color = ds_clean)) + 
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE)
```



```{r}
pred_df_with_curve_shape %>%
  filter(mean_age_months < 36) %>% 
  ggplot(aes(x = mean_age_months, y = prediction, color = ds_clean)) + 
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE) + 
  facet_grid(model_moderators_type~model_spec_clean)
```

```{r}
min_AIC_df$model_spec
```



```{r}



age_models_df %>% 
  filter(ic == "AICc") %>% 
   ggplot(aes(x = ic, y = REML, color = model_spec_clean, group = model_spec_clean)) + 
  geom_point(position = position_dodge(width = .2)) + 
  theme_classic() + 
  facet_wrap(~dataset, scales = "free")
```


```{r}
age_models_df %>% mutate(model_type = "base_age") %>% 
  bind_rows(kitchen_sink_models_df %>% mutate(model_type = "kitchen_sink")) %>% 
  filter(ic == "AICc") %>% 
   ggplot(aes(x = model_type, y = REML, color = model_spec_clean, group = model_spec_clean)) + 
  geom_point(position = position_dodge(width = .2)) + 
  theme_classic() + 
  facet_wrap(~dataset) + 
  labs(title ="AICc", scales = "free")
```




```{r}
test_d <- d %>% filter(ds_clean == "Gaze following (combined)")
test_d <- test_d %>% mutate(cue_type = as.factor(cue_type))

contrasts(test_d$cue_type) <-  contr.sum(4)




res_m_method <- rma.mv(d_calc ~ mean_age_months + cue_type, 
    V = d_var_calc, 
    random = ~ 1 | short_cite/same_infant/unique_row, 
    data = test_d)

res_m_method_log <- rma.mv(d_calc ~ log(mean_age_months) + cue_type, 
    V = d_var_calc, 
    random = ~ 1 | short_cite/same_infant/unique_row, 
    data = test_d)

res_method_square <-  rma.mv(d_calc ~ I(mean_age_months^2) + cue_type, 
    V = d_var_calc, 
    random = ~ 1 | short_cite/same_infant/unique_row, 
    data = test_d)

p.res_method <- predict(res_m_method, addx =TRUE) %>% as.data.frame()
p.res_method_log <- predict(res_m_method_log, addx = TRUE) %>% as.data.frame()
p.res_method_square <- predict(res_method_square, addx = TRUE) %>% as.data.frame()

prediction_df <- p.res_method %>% 
  rename(p.linear = pred)

prediction_df$p.log = p.res_method_log$pred
prediction_df$p.square = p.res_method_square$pred



prediction_df %>% 
  pivot_longer(cols = starts_with("p."), 
               names_to = "prediction_type", 
               values_to = "prediction_val") %>% 
  ggplot(aes(x = X.mean_age_months, y = prediction_val, color = prediction_type)) + 
  geom_point() + 
  facet_wrap(~prediction_type)

  left_join(p.res_method_log
            %>% rename(p.log = pred), 
            by = c("X.intrcpt", "X.mean_age_months", "X.cue_type1", "X.cue_type2", "X.cue_type3")) %>% 
  left_join(p.res_method_square %>% rename(p.square = pred), 
            by = c("X.intrcpt", "X.mean_age_months", "X.cue_type1", "X.cue_type2", "X.cue_type3"))





```


