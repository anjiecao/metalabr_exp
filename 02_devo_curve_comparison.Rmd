---
title: "02_devo_curve_comparison.Rmd"
author: "anjie"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(tidyverse)
library(here)
library(ggthemes)
library(metafor)
library(ggrepel)

d <- read_csv(here("data/metalab_data_mini.csv"))
source(here("helper/model_comparison_help.r"))
age_models_df <- readRDS(here("cached_data/age_models_df.Rds"))
```
# Fit Models 

```{r}
age_models_df <- lapply(unique(d$ds_clean), 
       function(name){
         print(name)
         get_compare_IC_df(d, name, NULL)
       }) %>% 
  bind_rows()

saveRDS(age_models_df, here("cached_data/age_models_df.Rds"))
```

# visualization 

```{r}
age_models_df %>% 
  filter(ic == "AICc") %>% 
  select(REML, model_spec_clean, dataset) %>% 
  group_by(dataset) %>% 
  mutate(
    min_REML = (REML == min(REML))
  ) %>% 
  ggplot(aes(x = model_spec_clean, y = REML, color = min_REML)) + 
  geom_point() + 
  facet_wrap(~dataset, scales = "free") + 
  theme(legend.position = "none") + 
  theme_few()
```

```{r}
age_models_df %>% 
  filter(ic == "AICc") %>% 
  rename(Dataset = dataset) %>% 
  select(REML, model_spec_clean, Dataset) %>% 
  pivot_wider(names_from = model_spec_clean, 
              values_from = REML) %>% 
  kableExtra::kable(digits = 2)
```


```{r}

age_df_wide <- age_models_df %>% 
  filter(ic == "AICc") %>% 
  rename(Dataset = dataset) %>% 
  select(REML, model_spec_clean, Dataset) %>% 
  pivot_wider(names_from = model_spec_clean, 
              values_from = REML)

age_df_wide$min <- apply(age_df_wide[c('Linear','Log', 'Quadratic', 'Const')], 1, min)

# get the delta value 
age_df_wide <- age_df_wide %>% 
  mutate(d_linear = Linear - min, 
         d_log = Log - min, 
         d_quad = Quadratic - min, 
         d_const= Const - min) %>% 
  select(Dataset, d_linear, d_log, d_quad, d_const) %>% 
  rename(Linear = d_linear, 
         Log = d_log, 
         Quadratic = d_quad, 
         Const = d_const) %>% 
   mutate(across(where(is.numeric), round, 2)) 


age_df_wide %>% 
  pivot_longer(cols = c("Linear", "Log", "Quadratic", "Const")) %>% 
  ggplot(aes(x = reorder(Dataset, value), y = value, color = name)) +
  theme_few() + 
  geom_hline(yintercept = 4, linetype = 2, color = "gray") + 
  geom_hline(yintercept = 0, linetype = 3) + 
  geom_point(position = position_dodge(width = .2), 
             #color = "white"
             ) + 

  coord_flip()+ 
  xlab("") + 
  labs(color = "Functional form") + 
  guides(colour = guide_legend(nrow = 2))  + 
  theme(legend.position = "top")
```


4 different results: 

Categorization bias: fixed random effect structure (add same_infant)
Statistical sound category learning (habituation): changed random effect structure (add same_infant)
Infant directed speech preference: added unique_row 
Mispronunciation sensitivity: fixed two missing infants age 



## cf const 

```{r}
age_df_wide %>% 
  filter(Const == 0) %>% 
  pivot_longer(cols = c("Linear", "Log", "Quadratic", "Const")) %>% 
  ggplot(aes(x = reorder(Dataset, value), y = value, color = name)) +
  theme_few() + 
  geom_hline(yintercept = 4, linetype = 2, color = "gray") + 
  geom_hline(yintercept = 0, linetype = 3) + 
  geom_point(position = position_dodge(width = .2), 
             #color = "white"
             ) + 

  coord_flip()+ 
  xlab("") + 
  labs(color = "Functional form") + 
  guides(colour = guide_legend(nrow = 2))  + 
  theme(legend.position = "top")
```

linear_model_formula <-"d_calc ~ mean_age_months"
log_model_formula <- "d_calc ~ log(mean_age_months)"
qua_model_formula <- "d_calc ~ I(mean_age_months^2)"
const_model_formula <- "d_calc ~ 1"
    
    
```{r}
ds_name =

linear_model_formula <-"d_calc ~ mean_age_months"
log_model_formula <- "d_calc ~ log(mean_age_months)"
qua_model_formula <- "d_calc ~ I(mean_age_months^2)"
const_model_formula <- "d_calc ~ 1"

m1 <- rma.mv(as.formula(linear_model_formula), 
                                       V = d_var_calc, 
                                             random = ~ 1 | short_cite/unique_row, 
                                             data = d %>% filter(ds_clean == "Abstract rule learning"), 
             method="ML")

m2 <- rma.mv(as.formula(const_model_formula), 
                                       V = d_var_calc, 
                                             random = ~ 1 | short_cite/unique_row, 
                                             data = d %>% filter(ds_clean == "Abstract rule learning"), 
             method="ML")


anova(m1, m2)$pval
```

```{r}

get_model_type <- function(s){
  if (grepl("log", s)){
    return ("log")
  }else if (grepl("2", s)){
    return ("quad")
  }else{
    return ("linear")
  }
}

get_const_comparion <- function(all_ds, ds_name){
  
  const_m <- rma.mv(d_calc ~ 1, 
                  V = d_var_calc, 
                  random = ~ 1 | short_cite/same_infant/unique_row, 
                  data = all_ds %>% filter(ds_clean == ds_name), 
                  method = "ML")
  
  linear_model_formula <-"d_calc ~ mean_age_months"
  log_model_formula <- "d_calc ~ log(mean_age_months)"
  qua_model_formula <- "d_calc ~ I(mean_age_months^2)"
  
  res = lapply(c(linear_model_formula, 
                 log_model_formula, 
                 qua_model_formula), 
               function(f){
                 
                 m <- rma.mv(as.formula(f), 
                             V = d_var_calc, 
                             random = ~ 1 | short_cite/same_infant/unique_row, 
                              data = all_ds %>% filter(ds_clean == ds_name), 
                             method = "ML")
                 
                m_type <- get_model_type(f)
                
                res <- anova(m, const_m)
                return (tibble(
                  "m_type" = m_type, 
                  "pval" = res$pval
                ))
                 
                 
                 
                 
               }) %>% bind_rows()
  
  return(res %>% mutate(ds_name = ds_name))
  
  
}


compare_const_df <- lapply(unique(d$ds_clean), 
       function(name){
         print(name)
         get_const_comparion(d, name)
       }) %>% 
  bind_rows()

saveRDS(compare_const_df, here("cached_data/compare_const_df.Rds"))

```

    
```{r}
compare_const_df <- readRDS( here("cached_data/compare_const_df.Rds"))
compare_const_df %>% 
  ggplot(aes(x = ds_name, y = pval, color = m_type)) + 
  geom_point(position = position_dodge(width = .2), alpha = .3) + 
  theme_few() +
  geom_hline(yintercept = 0.05) +  
  coord_flip()
```

# Get predictions 

```{r}

get_age_model_prediction <- function(ds_name, min_age_df, all_ds){
  
  current_df = all_ds %>% filter(ds_clean == ds_name)
  formula = (min_age_df %>% filter(dataset == ds_name))$model_spec
  model_type = (min_age_df %>% filter(dataset == ds_name))$model_spec_clean
  model <- rma.mv(as.formula(formula), 
                    V = d_var_calc, 
                    random = ~ 1 | short_cite/same_infant/unique_row, 
                    data = current_df)
    
 
  
  if (model_type == "Log"){
    age = log(seq(1, 36, .5))
  }else if(model_type == "Quadratic"){
    age = (seq(1, 36, .5)) ** 2
  }else{
    age = seq(1, 36, .5)
  }
  
  if (model_type != "Const"){
    prediction =  predict(model, newmods = age, addx =TRUE) %>% 
      as.data.frame() %>% 
      mutate(ds_name = ds_name)
    
  }else{
    
    prediction = predict(model) %>% 
      as.data.frame() 
    
    prediction = map_dfr(seq(length(age)), ~prediction)
    
    prediction$X.const.mean_age_months = age
    
    
    prediction$ds_name = ds_name
    
  }

  
  return (prediction)
}

age_range_df <- d %>% 
  group_by(ds_clean) %>% 
  summarise(min_age = min(mean_age_months, na.rm = TRUE), 
            max_age = max(mean_age_months, na.rm = TRUE)) %>% 
  rename(ds_name = ds_clean)

ds_names = unique(d$ds_clean)
model_type = c("Log", "Quadratic", "Const", "Linear")
age_models_df <- readRDS(here("cached_data/age_models_df.RDS")) %>% 
  filter(ic == "AICc") %>% 
  group_by(dataset) %>% 
  filter(REML == min(REML))

pred_res <- lapply(ds_names, function(name){
  
  get_age_model_prediction(name, age_models_df, d)
}) %>% 
  bind_rows()
```


```{r}



ids_pred <- ids_all_model_df %>% 
  select(pred, ds_name, model_type, ci.lb, ci.ub) %>% 
  group_by(ds_name,model_type) %>% 
  mutate(mean_age_months = (row_number() + 1) / 2) %>% 
  left_join(age_range_df, by = c("ds_name")) %>% 
  filter(mean_age_months > min_age, 
         mean_age_months < min(36, max_age)) %>% 

  select(ds_name,  mean_age_months, pred, ci.lb, ci.ub)
```



